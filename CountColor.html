<html>
	<head>
		<meta name="viewport" content="width=device-width, user-scalable=no" />
		<style>
			.wrapper {
				display: grid;
				grid-gap: 10px;
				grid-template-columns: repeat(6, 1fr);
				grid-template-rows: repeat(6, 1fr);
				height:100%;
			}
			.wrapper > div {
				display: grid;
				border-radius : 5px;
				align-items: center;
				justify-items: center;
				font-weight : 1000;
				font-size: 2em;
			}
			#case1 {
				grid-column: 1/4;
				grid-row: 1/4;
			}
			#case2 {
				grid-column: 4/7;
				grid-row: 1/4;
			}
			#case3 {
				grid-column: 1/4;
				grid-row: 4/7;
			}
			#case4 {
				grid-column: 4/7;
				grid-row: 4/7;
			}
			#case5 {
				grid-column: 3/5;
				grid-row: 3/5;
				border : 2px solid black;
			}
			.blue {
				border : 2px solid #3380FF;
				background-color: #33BBFF;
			}
			.red {
				border : 2px solid red;
				background-color : #FF3333;
			}
			.yellow {
				border : 2px solid #E4E713;
				background-color : #FFEC00;
			}
			.white {
				border : 2px solid black;
				background-color : #FFFFFF;
			}
			.lightgray {
				background-color : #E5E8E8;
			}
			.help-button {
				position: fixed;
				top: 12px;
				right: 12px;
				width: 36px;
				height: 36px;
				border: 2px solid #222;
				border-radius: 50%;
				background: #fff;
				font-weight: 900;
				font-size: 16px;
				cursor: pointer;
				box-shadow: 0 2px 6px rgba(0,0,0,0.2);
			}
			.help-panel {
				position: fixed;
				top: 60px;
				right: 12px;
				width: min(340px, 90vw);
				padding: 12px;
				background: #ffffff;
				border: 2px solid #222;
				border-radius: 6px;
				box-shadow: 0 4px 12px rgba(0,0,0,0.25);
				font-size: 14px;
				line-height: 1.3;
				display: none;
				z-index: 10;
			}
			.help-panel.visible {
				display: block;
			}
			.help-panel ul {
				margin: 8px 0 0;
				padding-left: 18px;
			}
		</style>
	</head>
	<body>
		<button class="help-button" aria-label="Afficher l'aide">?</button>
		<div class="help-panel" role="dialog" aria-label="Aide compteur">
			<strong>Rappels rapides</strong>
			<ul>
				<li>Appui court sur une couleur : +1</li>
				<li>Appui long (&gt;0.5s) : -1</li>
				<li>Double-clic au centre : r√©initialise</li>
			</ul>
		</div>
		<div class="wrapper">
			<div id="case1" class="color blue">0</div>
			<div id="case2" class="color red">0</div>
			<div id="case3" class="color yellow">0</div>
			<div id="case4" class="color white">0</div>
			<div id="case5" class="result lightgray"></div>
		</div>
		<script>
			let resultSquare = document.querySelector('.result')
			let NbCouleur = new Map([
				['blue',0],
				['red',0],
				['yellow',0],
				['white',0]
				]);
			let longPressTimers = new Map()
			let helpButton = document.querySelector('.help-button')
			let helpPanel = document.querySelector('.help-panel')

			//Add event click for count
			let coloredSquares = document.querySelectorAll('.color');
			coloredSquares.forEach(square => {
				square.dataset.longPressTriggered = "false"
				square.addEventListener('click', function(event) {
					if (square.dataset.longPressTriggered === "true") {
						square.dataset.longPressTriggered = "false"
						return
					}
					let target = event.target;
					addcount(target);
				});
				square.addEventListener('pointerdown', function() {
					startLongPress(square)
				})
				square.addEventListener('pointerup', function() {
					cancelLongPress(square)
				})
				square.addEventListener('pointerleave', function() {
					cancelLongPress(square)
				})
			});

			//Clear Count + Inner div on dblclick
			resultSquare.addEventListener('dblclick', function() {
				for (let [key, value] of NbCouleur.entries()){
					NbCouleur.set(key,0) 
					document.querySelector('.'+key).innerHTML = 0
				}
				resultSquare.className = "result lightgray"
				resultSquare.innerHTML = ""
			})

			//Write counter in div and save the value in the map
			function addcount(Obj){
				const colorClassName = Obj.className.split(" ")[1]
				NbCouleur.set(colorClassName,NbCouleur.get(colorClassName) + 1)
				Obj.innerHTML = NbCouleur.get(colorClassName)

				maxColor()
			}

			function subtractCount(square){
				const colorClassName = square.className.split(" ")[1]
				let current = NbCouleur.get(colorClassName)
				if (current === 0) return

				NbCouleur.set(colorClassName, current - 1)
				square.innerHTML = NbCouleur.get(colorClassName)
				maxColor()
			}

			function startLongPress(square){
				cancelLongPress(square)
				longPressTimers.set(square, setTimeout(() => {
					square.dataset.longPressTriggered = "true"
					subtractCount(square)
				}, 500))
			}

			function cancelLongPress(square){
				if (!longPressTimers.has(square)) return
				clearTimeout(longPressTimers.get(square))
				longPressTimers.delete(square)
			}

			//Change class on the center div to the max counter
			function maxColor(){
				let max = (Math.max(...NbCouleur.values()));

				for (let [key, value] of NbCouleur.entries()) {
					if (value === max){
						resultSquare.className = "result"
						resultSquare.classList.add(key)
					}
				}
			}

			helpButton.addEventListener('click', () => {
				helpPanel.classList.toggle('visible')
			})

			document.addEventListener('click', (evt) => {
				if (!helpPanel.classList.contains('visible')) return
				if (evt.target === helpButton || helpPanel.contains(evt.target)) return
				helpPanel.classList.remove('visible')
			})

			/*Scale font*/
			document.body.setScaledFont = function (f) {
				var s = this.offsetWidth,
				fs = s * f;
				this.style.fontSize = fs + '%';
				return this
			};

			document.body.setScaledFont(0.35);
			window.onresize = function () {
				document.body.setScaledFont(0.35);
			}
			/*end scale font*/
		</script>
	</body>
</html>
